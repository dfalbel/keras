<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing Custom Keras Layers • keras</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Writing Custom Keras Layers">
<meta property="og:description" content="keras">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">keras</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.3.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/getting_started.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_classification.html">Basic Classification</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_text_classification.html">Text Classification</a>
    </li>
    <li>
      <a href="../articles/tutorial_basic_regression.html">Basic Regression</a>
    </li>
    <li>
      <a href="../articles/tutorial_overfit_underfit.html">Overfitting and Underfitting</a>
    </li>
    <li>
      <a href="../articles/tutorial_save_and_restore.html">Save and Restore Models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Using Keras</li>
    <li>
      <a href="../articles/guide_keras.html">Guide to Keras Basics</a>
    </li>
    <li>
      <a href="../articles/sequential_model.html">Sequential Model in Depth</a>
    </li>
    <li>
      <a href="../articles/functional_api.html">Functional API in Depth</a>
    </li>
    <li>
      <a href="../articles/about_keras_models.html">About Keras Models</a>
    </li>
    <li>
      <a href="../articles/about_keras_layers.html">About Keras Layers</a>
    </li>
    <li>
      <a href="../articles/training_visualization.html">Training Visualization</a>
    </li>
    <li>
      <a href="../articles/applications.html">Pre-Trained Models</a>
    </li>
    <li>
      <a href="../articles/faq.html">Frequently Asked Questions</a>
    </li>
    <li>
      <a href="../articles/why_use_keras.html">Why Use Keras?</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/eager_guide.html">Eager Execution</a>
    </li>
    <li>
      <a href="../articles/training_callbacks.html">Training Callbacks</a>
    </li>
    <li>
      <a href="../articles/backend.html">Keras Backend</a>
    </li>
    <li>
      <a href="../articles/custom_layers.html">Custom Layers</a>
    </li>
    <li>
      <a href="../articles/custom_models.html">Custom Models</a>
    </li>
    <li>
      <a href="../articles/saving_serializing.html">Saving and serializing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/learn.html">Learn</a>
</li>
<li>
  <a href="../articles/tools.html">Tools</a>
</li>
<li>
  <a href="../articles/examples/index.html">Examples</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li>
  <a href="https://github.com/rstudio/keras">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/keras/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="custom_layers_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing Custom Keras Layers</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/keras/blob/master/vignettes/custom_layers.Rmd"><code>vignettes/custom_layers.Rmd</code></a></small>
      <div class="hidden name"><code>custom_layers.Rmd</code></div>

    </div>

    
    
<p>If the existing Keras layers don’t meet your requirements you can create a custom layer. For simple, stateless custom operations, you are probably better off using <code><a href="../reference/layer_lambda.html">layer_lambda()</a></code> layers. But for any custom operation that has trainable weights, you should implement your own layer.</p>
<p>The example below illustrates the skeleton of a Keras custom layer. The <a href="https://keras.rstudio.com/articles/examples/mnist_antirectifier.html">mnist_antirectifier</a> example includes another demonstration of creating a custom layer.</p>
<div id="keraslayer-r6-class" class="section level2">
<h2 class="hasAnchor">
<a href="#keraslayer-r6-class" class="anchor"></a>KerasLayer R6 Class</h2>
<p>To create a custom Keras layer, you create an R6 class derived from <code>KerasLayer</code>. There are three methods to implement (only one of which, <code><a href="https://rdrr.io/r/base/call.html">call()</a></code>, is required for all types of layer):</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/utils/PkgUtils.html">build(input_shape)</a></code>: This is where you will define your weights. Note that if your layer doesn’t define trainable weights then you need not implemented this method.</li>
<li>
<code><a href="https://rdrr.io/r/base/call.html">call(x)</a></code>: This is where the layer’s logic lives. Unless you want your layer to support masking, you only have to care about the first argument passed to <code>call</code>: the input tensor.</li>
<li>
<code>compute_output_shape(input_shape)</code>: In case your layer modifies the shape of its input, you should specify here the shape transformation logic. This allows Keras to do automatic shape inference. If you don’t modify the shape of the input then you need not implement this method.</li>
</ul>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">keras</span>)

<span class="no">CustomLayer</span> <span class="kw">&lt;-</span> <span class="kw pkg">R6</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/R6/man/R6Class.html">R6Class</a></span>(<span class="st">"CustomLayer"</span>,

  <span class="kw">inherit</span> <span class="kw">=</span> <span class="no">KerasLayer</span>,

  <span class="kw">public</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(

    <span class="kw">output_dim</span> <span class="kw">=</span> <span class="kw">NULL</span>,

    <span class="kw">kernel</span> <span class="kw">=</span> <span class="kw">NULL</span>,

    <span class="kw">initialize</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">output_dim</span>) {
      <span class="no">self</span>$<span class="no">output_dim</span> <span class="kw">&lt;-</span> <span class="no">output_dim</span>
    },

    <span class="kw">build</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input_shape</span>) {
      <span class="no">self</span>$<span class="no">kernel</span> <span class="kw">&lt;-</span> <span class="no">self</span>$<span class="fu">add_weight</span>(
        <span class="kw">name</span> <span class="kw">=</span> <span class="st">'kernel'</span>,
        <span class="kw">shape</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">input_shape</span><span class="kw">[[</span><span class="fl">2</span>]], <span class="no">self</span>$<span class="no">output_dim</span>),
        <span class="kw">initializer</span> <span class="kw">=</span> <span class="fu"><a href="../reference/initializer_random_normal.html">initializer_random_normal</a></span>(),
        <span class="kw">trainable</span> <span class="kw">=</span> <span class="fl">TRUE</span>
      )
    },

    <span class="kw">call</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">mask</span> <span class="kw">=</span> <span class="kw">NULL</span>) {
      <span class="fu"><a href="../reference/k_dot.html">k_dot</a></span>(<span class="no">x</span>, <span class="no">self</span>$<span class="no">kernel</span>)
    },

    <span class="kw">compute_output_shape</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input_shape</span>) {
      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">input_shape</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">self</span>$<span class="no">output_dim</span>)
    }
  )
)</pre></body></html></div>
<p>Note that tensor operations are executed using the Keras <code><a href="../reference/backend.html">backend()</a></code>. See the Keras Backend article for details on the various functions available from Keras backends.</p>
</div>
<div id="layer-wrapper-function" class="section level2">
<h2 class="hasAnchor">
<a href="#layer-wrapper-function" class="anchor"></a>Layer Wrapper Function</h2>
<p>In order to use the custom layer within a Keras model you also need to create a wrapper function which instantiates the layer using the <code><a href="../reference/create_layer.html">create_layer()</a></code> function. For example:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># define layer wrapper function</span>
<span class="no">layer_custom</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">object</span>, <span class="no">output_dim</span>, <span class="no">name</span> <span class="kw">=</span> <span class="kw">NULL</span>, <span class="no">trainable</span> <span class="kw">=</span> <span class="fl">TRUE</span>) {
  <span class="fu"><a href="../reference/create_layer.html">create_layer</a></span>(<span class="no">CustomLayer</span>, <span class="no">object</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="kw">output_dim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">output_dim</span>),
    <span class="kw">name</span> <span class="kw">=</span> <span class="no">name</span>,
    <span class="kw">trainable</span> <span class="kw">=</span> <span class="no">trainable</span>
  ))
}

<span class="co"># use it in a model</span>
<span class="no">model</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/keras_model_sequential.html">keras_model_sequential</a></span>()
<span class="no">model</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/layer_dense.html">layer_dense</a></span>(<span class="kw">units</span> <span class="kw">=</span> <span class="fl">32</span>, <span class="kw">input_shape</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">32</span>,<span class="fl">32</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">layer_custom</span>(<span class="kw">output_dim</span> <span class="kw">=</span> <span class="fl">32</span>)</pre></body></html></div>
<p>Some important things to note about the layer wrapper function:</p>
<ol style="list-style-type: decimal">
<li><p>It accepts <code>object</code> as its first parameter (the object will either be a Keras sequential model or another Keras layer). The <code>object</code> parameter enables the layer to be composed with other layers using the magrittr pipe (<code><a href="../reference/pipe.html">%&gt;%</a></code>) operator.</p></li>
<li><p>It converts it’s <code>output_dim</code> to integer using the <code><a href="https://rdrr.io/r/base/integer.html">as.integer()</a></code> function. This is done as convenience to the user because Keras variables are strongly typed (you can’t pass a float if an integer is expected). This enables users of the function to write <code>output_dim = 32</code> rather than <code>output_dim = 32L</code>.</p></li>
<li><p>Some additional parameters not used by the layer (<code>name</code> and <code>trainable</code>) are in the function signature. Custom layer functions can include any of the core layer function arguments (<code>input_shape</code>, <code>batch_input_shape</code>, <code>batch_size</code>, <code>dtype</code>, <code>name</code>, <code>trainable</code>, and <code>weights</code>) and they will be automatically forwarded to the Layer base class.</p></li>
</ol>
<p>See the <a href="https://keras.rstudio.com/articles/examples/mnist_antirectifier.html">mnist_antirectifier</a> example for another demonstration of creating a custom layer.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falbel, JJ Allaire, François Chollet,  RStudio,  Google.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
